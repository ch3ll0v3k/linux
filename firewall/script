#!/bin/bash

# ---------------------------------------------------------------------
# которкая справка
# sudo iptables --help

# полная справка
# man iptables

# ---------------------------------------------------------------------
# переменные 
NEW_NO_INET_GROUP="имя группы на которую будер действовать это праило"
BLOCK_ON_IFACE="eth1"
THIS_USER="имя пользователя"

# ---------------------------------------------------------------------
# Эти переменные уже есть в bash
# $USER == имя текущего пользователя
# $UID == ID текущего пользователя

# удалить группу 
#sudo groupdel $NEW_NO_INET_GROUP 

# создать новую группу 
sudo groupadd $NEW_NO_INET_GROUP 


# удалить пользователя из группы
sudo deluser $THIS_USER $NEW_NO_INET_GROUP 

# добавить пользователя в группу
sudo adduser $THIS_USER $NEW_NO_INET_GROUP 

# ---------------------------------------------------------------------
# добавить новое правило iptables

# sudo iptables -I OUTPUT -o $BLOCK_ON_IFACE -m owner --gid-owner $NEW_NO_INET_GROUP -p all -j DROP

sudo iptables -I \
OUTPUT \
-o $BLOCK_ON_IFACE \
-m owner \
--gid-owner $NEW_NO_INET_GROUP \
-p all \
-j DROP

# -j DROP / ACCEPT / FOREWARD / или REJECT => что делать если есть совпадения.

# --cmd-owner [имя просесса]
# ---------------------------------------------------------------------
echo "----------------------------------------------------------------"
# показать текущие правила
sudo iptables -L

# ---------------------------------------------------------------------
# sudo iptables -I \                  # вставить это правило в начало
# OUTPUT \                            # исходящий поток
# -o $BLOCK_ON_IFACE \                # на какой сетевой адаптер это правило
# -m owner \                          # по совподению с на то что ижет ниже, (группу)
# --gid-owner $NEW_NO_INET_GROUP \    # на группу
# -p all \                            # протокол (icmp,tcp,udp, или all) all идет по дефолку, можно не указывать
# -j DROP или REJECT                  # отклонить все запросы

# DROP      :это станжартное 
# REJECT    :это разширенное, на пример в RedHad часто юзается.

# ---------------------------------------------------------------------
# запустить программу которая попала бы под правила firewall можнотак

#sudo -g no-internet ./programm
#sudo -g no-internet subl

# или создать,пользовательски скрипт для быстрого запуска 
# и положить его в /usr/local/bin или /usr/bin

# к примеру его назову "u-script"

# ------------------------------------
#   #!/bin/bash
#   sudo -g no-internet $*
# ------------------------------------

# теперь и терминала можно будет вызывать просто

# u-script [имяпрограммы]

# ---------------------------------------------------------------------


